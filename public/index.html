<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Detail Search</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow:wght@300;400;500;600;700&family=Barlow+Condensed:wght@500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d1117;
    --bg2: #161b22;
    --bg3: #21262d;
    --border: #30363d;
    --border-active: #3d8bcd;
    --text: #e6edf3;
    --text-muted: #7d8590;
    --text-dim: #484f58;
    --accent: #2188d8;
    --accent-glow: rgba(33,136,216,0.15);
    --accent2: #3fb950;
    --warn: #e3b341;
    --danger: #da3633;
    --mono: 'Share Tech Mono', monospace;
    --sans: 'Barlow', sans-serif;
    --cond: 'Barlow Condensed', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* ---- Header ---- */
  header {
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    height: 56px;
    display: flex;
    align-items: center;
    gap: 16px;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    font-family: var(--cond);
    font-size: 20px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--accent);
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
  }

  .logo svg { opacity: 0.9; }

  .header-search {
    flex: 1;
    max-width: 600px;
    position: relative;
  }

  .header-search input {
    width: 100%;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 7px 40px 7px 14px;
    color: var(--text);
    font-family: var(--sans);
    font-size: 14px;
    outline: none;
    transition: border-color 0.15s;
  }

  .header-search input:focus { border-color: var(--border-active); }
  .header-search input::placeholder { color: var(--text-dim); }

  .header-search .search-icon {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-dim);
    pointer-events: none;
  }

  .project-filter {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 7px 10px;
    color: var(--text);
    font-family: var(--sans);
    font-size: 13px;
    outline: none;
    cursor: pointer;
    min-width: 160px;
  }

  .project-filter:focus { border-color: var(--border-active); }

  .header-actions { margin-left: auto; display: flex; gap: 8px; }

  btn, .btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 7px 14px;
    border-radius: 6px;
    font-family: var(--sans);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.15s;
    text-decoration: none;
    white-space: nowrap;
  }

  .btn-primary {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
  }
  .btn-primary:hover { background: #1a7abf; border-color: #1a7abf; }

  .btn-ghost {
    background: transparent;
    color: var(--text-muted);
    border-color: var(--border);
  }
  .btn-ghost:hover { color: var(--text); border-color: #6e7681; background: var(--bg3); }

  .btn-danger { background: transparent; color: var(--danger); border-color: var(--danger); }
  .btn-danger:hover { background: rgba(218,54,51,0.1); }

  /* ---- Layout ---- */
  .layout { display: flex; flex: 1; overflow: hidden; height: calc(100vh - 56px); }

  /* ---- Sidebar ---- */
  .sidebar {
    width: 260px;
    min-width: 260px;
    background: var(--bg2);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-header {
    padding: 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .sidebar-title {
    font-family: var(--cond);
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-muted);
  }

  .project-list { flex: 1; overflow-y: auto; padding: 8px; }

  .project-item {
    padding: 10px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.1s;
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 2px;
    border: 1px solid transparent;
  }

  .project-item:hover { background: var(--bg3); }
  .project-item.active { background: var(--accent-glow); border-color: rgba(33,136,216,0.3); }

  .project-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--accent);
    flex-shrink: 0;
  }

  .project-item.active .project-dot { background: var(--accent); box-shadow: 0 0 6px var(--accent); }

  .project-info { flex: 1; min-width: 0; }

  .project-name {
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--text);
  }

  .project-meta {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 2px;
    font-family: var(--mono);
  }

  /* ---- Main ---- */
  .main { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }

  /* ---- Views ---- */
  .view { display: none; flex: 1; }
  .view.active { display: flex; flex-direction: column; }

  /* Welcome */
  #view-welcome {
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 40px;
  }

  .welcome-icon {
    width: 72px; height: 72px;
    background: var(--accent-glow);
    border: 1px solid rgba(33,136,216,0.3);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 24px;
  }

  .welcome-title {
    font-family: var(--cond);
    font-size: 28px;
    font-weight: 700;
    letter-spacing: 1px;
    margin-bottom: 10px;
  }

  .welcome-sub { color: var(--text-muted); font-size: 15px; max-width: 400px; line-height: 1.6; }

  /* Search Results */
  #view-search { padding: 24px; }

  .view-title {
    font-family: var(--cond);
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 16px;
  }

  .results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 16px;
  }

  .result-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    transition: border-color 0.15s, transform 0.15s;
    cursor: pointer;
  }

  .result-card:hover { border-color: var(--border-active); transform: translateY(-1px); }

  .result-img-wrap {
    position: relative;
    background: #fff;
    aspect-ratio: 4/3;
    overflow: hidden;
  }

  .result-img-wrap img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }

  .relevance-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(13,17,23,0.85);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 2px 8px;
    font-family: var(--mono);
    font-size: 11px;
    color: var(--accent);
  }

  .highlight-overlay {
    position: absolute;
    inset: 0;
    pointer-events: none;
  }

  .result-body { padding: 12px 14px; }

  .result-project {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--accent);
    font-family: var(--cond);
    margin-bottom: 4px;
  }

  .result-sheet {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 6px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .result-summary {
    font-size: 12px;
    color: var(--text-muted);
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-bottom: 8px;
  }

  .result-tags { display: flex; flex-wrap: wrap; gap: 4px; }

  .tag {
    font-family: var(--mono);
    font-size: 10px;
    padding: 2px 6px;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 3px;
    color: var(--text-muted);
  }

  /* Project view */
  #view-project { padding: 24px; }

  .project-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 24px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .project-view-name {
    font-family: var(--cond);
    font-size: 24px;
    font-weight: 700;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }

  .project-view-desc { color: var(--text-muted); font-size: 14px; }

  .upload-zone {
    border: 2px dashed var(--border);
    border-radius: 8px;
    padding: 32px;
    text-align: center;
    transition: all 0.2s;
    cursor: pointer;
    margin-bottom: 24px;
    position: relative;
  }

  .upload-zone:hover, .upload-zone.dragover {
    border-color: var(--border-active);
    background: var(--accent-glow);
  }

  .upload-zone input[type=file] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
  }

  .upload-title { font-size: 15px; font-weight: 500; margin-bottom: 6px; }
  .upload-sub { font-size: 13px; color: var(--text-muted); }

  .upload-progress {
    margin-bottom: 16px;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    display: none;
  }

  .upload-progress.visible { display: block; }

  .progress-bar-wrap {
    height: 4px;
    background: var(--bg3);
    border-radius: 2px;
    margin-top: 10px;
    overflow: hidden;
  }

  .progress-bar {
    height: 100%;
    background: var(--accent);
    border-radius: 2px;
    transition: width 0.3s;
    width: 0%;
  }

  .progress-bar.indeterminate {
    width: 40%;
    animation: indeterminate 1.2s ease-in-out infinite;
  }

  @keyframes indeterminate {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(350%); }
  }

  .details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 14px;
  }

  .detail-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    transition: border-color 0.15s;
    cursor: pointer;
  }

  .detail-card:hover { border-color: #6e7681; }

  .detail-card-img {
    background: #fff;
    aspect-ratio: 4/3;
    overflow: hidden;
  }

  .detail-card-img img { width: 100%; height: 100%; object-fit: contain; display: block; }

  .detail-card-body { padding: 10px 12px; }

  .detail-page {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text-dim);
    margin-bottom: 3px;
  }

  .detail-sheet { font-size: 12px; font-weight: 600; margin-bottom: 4px; }

  .detail-summary {
    font-size: 11px;
    color: var(--text-muted);
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .detail-status-error { border-color: rgba(218,54,51,0.4); }
  .detail-status-error .detail-sheet { color: var(--danger); }

  /* Modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    z-index: 200;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
    backdrop-filter: blur(4px);
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 12px;
    max-width: 1100px;
    width: 100%;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .modal-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .modal-title { font-size: 16px; font-weight: 600; flex: 1; }

  .modal-body { flex: 1; overflow: auto; display: flex; gap: 0; }

  .modal-img-side {
    flex: 1;
    background: #fff;
    position: relative;
    min-height: 400px;
    overflow: hidden;
  }

  .img-zoom-wrapper {
    position: absolute;
    inset: 0;
    transform-origin: center center;
    transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    will-change: transform;
  }

  .img-zoom-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }

  .modal-canvas {
    position: absolute;
    inset: 0;
    pointer-events: none;
  }

  .zoom-btn {
    position: absolute;
    bottom: 12px;
    right: 12px;
    display: none;
    align-items: center;
    gap: 6px;
    background: rgba(13,17,23,0.88);
    border: 1px solid var(--border-active);
    border-radius: 6px;
    color: var(--accent);
    padding: 6px 12px;
    font-family: var(--sans);
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    z-index: 10;
    transition: background 0.15s, box-shadow 0.15s;
    user-select: none;
  }

  .zoom-btn:hover { background: rgba(33,136,216,0.18); box-shadow: 0 0 0 1px var(--accent); }

  .modal-img-side.has-detail { cursor: zoom-in; }
  .modal-img-side.zoomed { cursor: zoom-out; }

  .modal-info-side {
    width: 320px;
    min-width: 320px;
    padding: 20px;
    overflow-y: auto;
    border-left: 1px solid var(--border);
  }

  .info-section { margin-bottom: 20px; }

  .info-label {
    font-family: var(--cond);
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 6px;
  }

  .info-value { font-size: 13px; line-height: 1.6; color: var(--text-muted); }

  .detail-list { display: flex; flex-direction: column; gap: 10px; }

  .detail-item {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px 12px;
    cursor: pointer;
    transition: border-color 0.15s;
  }

  .detail-item:hover, .detail-item.active { border-color: var(--border-active); }
  .detail-item.active { background: var(--accent-glow); }

  .detail-item-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; }

  .detail-item-desc {
    font-size: 12px;
    color: var(--text-muted);
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .detail-item-location {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text-dim);
    margin-top: 4px;
  }

  /* Empty states */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }

  .empty-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.4; }
  .empty-text { font-size: 14px; }

  /* New project modal */
  .form-group { margin-bottom: 16px; }

  .form-label {
    display: block;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-muted);
    margin-bottom: 6px;
    letter-spacing: 0.3px;
  }

  .form-input {
    width: 100%;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 9px 12px;
    color: var(--text);
    font-family: var(--sans);
    font-size: 14px;
    outline: none;
    transition: border-color 0.15s;
  }

  .form-input:focus { border-color: var(--border-active); }

  textarea.form-input { resize: vertical; min-height: 80px; }

  /* Toast */
  .toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 500;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .toast {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 13px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    animation: slideIn 0.2s ease;
    max-width: 320px;
  }

  .toast.success { border-color: var(--accent2); color: var(--accent2); }
  .toast.error { border-color: var(--danger); color: var(--danger); }
  .toast.info { border-color: var(--accent); color: var(--accent); }

  @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

  /* Scrollbars */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #6e7681; }

  .no-results {
    grid-column: 1/-1;
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }
</style>
</head>
<body>

<!-- Header -->
<header>
  <div class="logo">
    <svg width="22" height="22" viewBox="0 0 22 22" fill="none">
      <rect x="1" y="1" width="20" height="20" rx="3" stroke="#2188d8" stroke-width="1.5"/>
      <line x1="1" y1="8" x2="21" y2="8" stroke="#2188d8" stroke-width="1"/>
      <line x1="1" y1="14" x2="21" y2="14" stroke="#2188d8" stroke-width="1"/>
      <line x1="8" y1="1" x2="8" y2="21" stroke="#2188d8" stroke-width="1"/>
      <circle cx="11" cy="11" r="2.5" fill="#2188d8"/>
    </svg>
    Detail Search
  </div>

  <div class="header-search">
    <input type="text" id="searchInput" placeholder="Search details across all projects..." autocomplete="off">
    <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
    </svg>
  </div>

  <select class="project-filter" id="searchProjectFilter">
    <option value="">All Projects</option>
  </select>

  <div class="header-actions">
    <button class="btn btn-primary" onclick="openNewProjectModal()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
      New Project
    </button>
  </div>
</header>

<!-- Layout -->
<div class="layout">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="sidebar-title">Projects</span>
    </div>
    <div class="project-list" id="projectList">
      <div class="empty-state" style="padding:30px 10px">
        <div class="empty-icon">üìÅ</div>
        <div class="empty-text" style="font-size:12px">No projects yet</div>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <!-- Welcome -->
    <div class="view active" id="view-welcome">
      <div class="welcome-icon">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#2188d8" stroke-width="1.5">
          <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
          <polyline points="14 2 14 8 20 8"/>
          <line x1="8" y1="13" x2="16" y2="13"/>
          <line x1="8" y1="17" x2="16" y2="17"/>
          <line x1="8" y1="9" x2="10" y2="9"/>
        </svg>
      </div>
      <h1 class="welcome-title">Construction Detail Search</h1>
      <p class="welcome-sub">Create a project, upload your detail sheets, and search across all indexed details by keyword ‚Äî steel connections, deck angles, embedments, and more.</p>
    </div>

    <!-- Project view -->
    <div class="view" id="view-project">
      <div style="padding:24px">
        <div class="project-header">
          <div>
            <div class="project-view-name" id="projectViewName"></div>
            <div class="project-view-desc" id="projectViewDesc"></div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <span id="projectDetailCount" style="font-family:var(--mono);font-size:12px;color:var(--text-dim)"></span>
            <button class="btn btn-danger" id="deleteProjectBtn">Delete Project</button>
          </div>
        </div>

        <!-- Upload zone -->
        <div class="upload-zone" id="uploadZone">
          <input type="file" id="fileInput" accept="application/pdf" multiple>
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#484f58" stroke-width="1.5" style="margin-bottom:12px">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          <div class="upload-title">Drop detail sheet PDFs here</div>
          <div class="upload-sub">Or click to select files &mdash; multiple PDFs accepted</div>
        </div>

        <div class="upload-progress" id="uploadProgress">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span id="uploadProgressText" style="font-size:13px">Uploading...</span>
            <span id="uploadProgressFile" style="font-size:11px;font-family:var(--mono);color:var(--text-dim)"></span>
          </div>
          <div class="progress-bar-wrap"><div class="progress-bar indeterminate" id="progressBar"></div></div>
        </div>

        <div class="view-title" id="detailsLabel">INDEXED DETAILS</div>
        <div class="details-grid" id="detailsGrid"></div>
      </div>
    </div>

    <!-- Search results view -->
    <div class="view" id="view-search">
      <div class="view-title" id="searchResultsLabel">SEARCH RESULTS</div>
      <div class="results-grid" id="resultsGrid"></div>
    </div>
  </main>
</div>

<!-- Detail Modal -->
<div class="modal-overlay" id="detailModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle"></div>
      <button class="btn btn-ghost" onclick="closeModal()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg>
        Close
      </button>
    </div>
    <div class="modal-body">
      <div class="modal-img-side" id="modalImgSide" onclick="handleImgSideClick(event)">
        <div class="img-zoom-wrapper" id="imgZoomWrapper">
          <img id="modalImg" src="" alt="">
          <canvas class="modal-canvas" id="modalCanvas"></canvas>
        </div>
        <button class="zoom-btn" id="zoomBtn" onclick="handleZoomBtnClick(event)">
          <svg id="zoomBtnIcon" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/><path d="M11 8v6M8 11h6"/>
          </svg>
          <span id="zoomBtnLabel">Zoom to detail</span>
        </button>
      </div>
      <div class="modal-info-side">
        <div class="info-section">
          <div class="info-label">Project</div>
          <div class="info-value" id="modalProject"></div>
        </div>
        <div class="info-section">
          <div class="info-label">Source File</div>
          <div class="info-value" id="modalFile"></div>
        </div>
        <div class="info-section">
          <div class="info-label">Sheet Summary</div>
          <div class="info-value" id="modalSummary"></div>
        </div>
        <div class="info-section">
          <div class="info-label">Details on this sheet ‚Äî click to highlight</div>
          <div class="detail-list" id="modalDetailList"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New Project Modal -->
<div class="modal-overlay" id="newProjectModal">
  <div class="modal" style="max-width:440px">
    <div class="modal-header">
      <div class="modal-title">New Project</div>
      <button class="btn btn-ghost" onclick="closeNewProjectModal()">Cancel</button>
    </div>
    <div class="modal-body" style="flex-direction:column;padding:20px">
      <div class="form-group">
        <label class="form-label">Project Name *</label>
        <input type="text" class="form-input" id="newProjectName" placeholder="e.g. Oberlin Middle School">
      </div>
      <div class="form-group">
        <label class="form-label">Description (optional)</label>
        <textarea class="form-input" id="newProjectDesc" placeholder="School, 2-story, masonry..."></textarea>
      </div>
      <button class="btn btn-primary" onclick="createProject()" style="align-self:flex-end;margin-top:8px">Create Project</button>
    </div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
let projects = [];
let currentProjectId = null;
let currentDetail = null;
let searchTimeout = null;
let zoomActive = false;
let currentHighlightRegion = null;

// ============================================================
// INIT
// ============================================================
async function init() {
  await loadProjects();

  document.getElementById('searchInput').addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    const q = e.target.value.trim();
    if (!q) { showView('welcome'); return; }
    searchTimeout = setTimeout(() => search(q), 350);
  });
}

// ============================================================
// PROJECTS
// ============================================================
async function loadProjects() {
  const res = await fetch('/api/projects');
  projects = await res.json();
  renderSidebar();
  updateSearchFilter();
}

function renderSidebar() {
  const list = document.getElementById('projectList');
  if (projects.length === 0) {
    list.innerHTML = '<div class="empty-state" style="padding:30px 10px"><div class="empty-icon">üìÅ</div><div class="empty-text" style="font-size:12px">No projects yet</div></div>';
    return;
  }
  list.innerHTML = projects.map(p => `
    <div class="project-item ${currentProjectId === p._id ? 'active' : ''}" onclick="openProject('${p._id}')">
      <div class="project-dot"></div>
      <div class="project-info">
        <div class="project-name">${p.name}</div>
        <div class="project-meta">${new Date(p.createdAt).toLocaleDateString()}</div>
      </div>
    </div>
  `).join('');
}

function updateSearchFilter() {
  const sel = document.getElementById('searchProjectFilter');
  const cur = sel.value;
  sel.innerHTML = '<option value="">All Projects</option>' +
    projects.map(p => `<option value="${p._id}" ${cur === p._id ? 'selected' : ''}>${p.name}</option>`).join('');
}

async function openProject(id) {
  currentProjectId = id;
  const project = projects.find(p => p._id === id);
  document.getElementById('projectViewName').textContent = project.name;
  document.getElementById('projectViewDesc').textContent = project.description || '';
  document.getElementById('deleteProjectBtn').onclick = () => deleteProject(id);
  renderSidebar();
  showView('project');
  await loadDetails(id);
}

async function loadDetails(projectId) {
  const res = await fetch(`/api/projects/${projectId}/details`);
  const details = await res.json();
  document.getElementById('projectDetailCount').textContent = `${details.length} page${details.length !== 1 ? 's' : ''} indexed`;
  document.getElementById('detailsLabel').textContent = `INDEXED DETAIL SHEETS (${details.length})`;
  renderDetailsGrid(details);
}

function renderDetailsGrid(details) {
  const grid = document.getElementById('detailsGrid');
  if (details.length === 0) {
    grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">üìÑ</div><div class="empty-text">No details indexed yet ‚Äî upload a PDF above</div></div>';
    return;
  }
  grid.innerHTML = details.map(d => `
    <div class="detail-card ${d.status === 'error' ? 'detail-status-error' : ''}" onclick="openDetail(${JSON.stringify(d).replace(/"/g, '&quot;')})">
      <div class="detail-card-img"><img src="/${d.imagePath}" loading="lazy" alt=""></div>
      <div class="detail-card-body">
        <div class="detail-page">PAGE ${d.pageNumber} &middot; ${d.pdfName}</div>
        <div class="detail-sheet">${d.sheetTitle || 'Detail Sheet'}</div>
        <div class="detail-summary">${d.overallSummary || (d.status === 'error' ? 'Processing failed' : 'No description')}</div>
      </div>
    </div>
  `).join('');
}

async function deleteProject(id) {
  if (!confirm('Delete this project and all its indexed details?')) return;
  await fetch(`/api/projects/${id}`, { method: 'DELETE' });
  currentProjectId = null;
  showView('welcome');
  await loadProjects();
  toast('Project deleted', 'info');
}

// ============================================================
// NEW PROJECT MODAL
// ============================================================
function openNewProjectModal() {
  document.getElementById('newProjectModal').classList.add('open');
  setTimeout(() => document.getElementById('newProjectName').focus(), 100);
}

function closeNewProjectModal() {
  document.getElementById('newProjectModal').classList.remove('open');
  document.getElementById('newProjectName').value = '';
  document.getElementById('newProjectDesc').value = '';
}

async function createProject() {
  const name = document.getElementById('newProjectName').value.trim();
  if (!name) { toast('Project name required', 'error'); return; }
  const desc = document.getElementById('newProjectDesc').value.trim();
  const res = await fetch('/api/projects', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, description: desc })
  });
  const project = await res.json();
  closeNewProjectModal();
  await loadProjects();
  openProject(project._id);
  toast(`Project "${name}" created`, 'success');
}

// ============================================================
// UPLOAD
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
  const zone = document.getElementById('uploadZone');
  const fileInput = document.getElementById('fileInput');

  zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
  zone.addEventListener('drop', (e) => {
    e.preventDefault();
    zone.classList.remove('dragover');
    const files = [...e.dataTransfer.files].filter(f => f.type === 'application/pdf');
    if (files.length) uploadFiles(files);
  });

  fileInput.addEventListener('change', (e) => {
    if (e.target.files.length) uploadFiles([...e.target.files]);
    fileInput.value = '';
  });

  init();
});

async function uploadFiles(files) {
  if (!currentProjectId) return;
  const progress = document.getElementById('uploadProgress');
  const progressText = document.getElementById('uploadProgressText');
  const progressFile = document.getElementById('uploadProgressFile');
  progress.classList.add('visible');

  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    progressText.textContent = `Uploading ${i + 1} of ${files.length} ‚Äî AI indexing will continue in background`;
    progressFile.textContent = file.name;

    const formData = new FormData();
    formData.append('pdf', file);

    try {
      await fetch(`/api/projects/${currentProjectId}/upload`, { method: 'POST', body: formData });
    } catch (e) {
      toast(`Upload failed: ${file.name}`, 'error');
    }
  }

  progress.classList.remove('visible');
  toast(`${files.length} PDF${files.length > 1 ? 's' : ''} uploaded ‚Äî indexing in background`, 'info');

  // Poll for new details
  pollForDetails();
}

function pollForDetails() {
  let polls = 0;
  const interval = setInterval(async () => {
    polls++;
    await loadDetails(currentProjectId);
    if (polls > 60) clearInterval(interval); // stop after ~5 min
  }, 5000);
}

// ============================================================
// SEARCH
// ============================================================
async function search(q) {
  const projectId = document.getElementById('searchProjectFilter').value;
  const url = `/api/search?q=${encodeURIComponent(q)}${projectId ? '&projectId=' + projectId : ''}`;
  const res = await fetch(url);
  const results = await res.json();
  showView('search');
  document.getElementById('searchResultsLabel').textContent = `SEARCH RESULTS ‚Äî "${q}" (${results.length} found)`;
  renderResults(results, q);
}

function renderResults(results, q) {
  const grid = document.getElementById('resultsGrid');
  if (results.length === 0) {
    grid.innerHTML = '<div class="no-results"><div style="font-size:32px;opacity:0.3;margin-bottom:12px">üîç</div><div>No matching details found</div></div>';
    return;
  }

  const terms = q.toLowerCase().split(/\s+/);

  grid.innerHTML = results.map(r => {
    const matchedDetails = r.details.filter(d =>
      terms.some(t => (d.description + ' ' + d.keywords.join(' ') + ' ' + d.title).toLowerCase().includes(t))
    );

    const tags = [...new Set([...r.generalKeywords, ...r.details.flatMap(d => d.keywords)])].slice(0, 6);

    return `
      <div class="result-card" onclick="openDetail(${JSON.stringify(r).replace(/"/g, '&quot;')}, '${q}')">
        <div class="result-img-wrap">
          <img src="/${r.imagePath}" loading="lazy" alt="">
          <div class="relevance-badge">score: ${r.relevanceScore}</div>
        </div>
        <div class="result-body">
          <div class="result-project">${r.projectName}</div>
          <div class="result-sheet">${r.sheetTitle || 'Detail Sheet'}</div>
          <div class="result-summary">${r.overallSummary}</div>
          <div class="result-tags">${tags.map(t => `<span class="tag">${t}</span>`).join('')}</div>
        </div>
      </div>
    `;
  }).join('');
}

// ============================================================
// DETAIL MODAL
// ============================================================
function openDetail(detail, searchQuery) {
  resetZoomState();
  currentDetail = detail;
  document.getElementById('modalTitle').textContent = detail.sheetTitle || 'Detail Sheet';
  document.getElementById('modalProject').textContent = detail.projectName || '‚Äî';
  document.getElementById('modalFile').textContent = `${detail.pdfName} ‚Äî Page ${detail.pageNumber}`;
  document.getElementById('modalSummary').textContent = detail.overallSummary || '‚Äî';

  const img = document.getElementById('modalImg');
  img.src = '/' + detail.imagePath;
  img.onload = () => setupCanvas(detail, searchQuery);

  const list = document.getElementById('modalDetailList');
  if (!detail.details || detail.details.length === 0) {
    list.innerHTML = '<div style="color:var(--text-dim);font-size:12px">No detail breakdown available</div>';
  } else {
    list.innerHTML = detail.details.map((d, i) => `
      <div class="detail-item" onclick="highlightDetail(${i})" id="detail-item-${i}">
        <div class="detail-item-title">${d.title}</div>
        <div class="detail-item-desc">${d.description}</div>
        <div class="detail-item-location">üìç ${d.location}</div>
      </div>
    `).join('');
  }

  document.getElementById('detailModal').classList.add('open');

  // Auto-highlight best matching detail if from search
  if (searchQuery && detail.details && detail.details.length > 0) {
    const terms = searchQuery.toLowerCase().split(/\s+/);
    let bestIdx = 0, bestScore = 0;
    detail.details.forEach((d, i) => {
      const text = (d.description + ' ' + d.title + ' ' + d.keywords.join(' ')).toLowerCase();
      const score = terms.reduce((s, t) => s + (text.includes(t) ? 1 : 0), 0);
      if (score > bestScore) { bestScore = score; bestIdx = i; }
    });
    setTimeout(() => highlightDetail(bestIdx), 300);
  }
}

function closeModal() {
  document.getElementById('detailModal').classList.remove('open');
  clearCanvas();
  resetZoomState();
}

function setupCanvas(detail, searchQuery) {
  const canvas = document.getElementById('modalCanvas');
  const img = document.getElementById('modalImg');
  canvas.width = img.offsetWidth;
  canvas.height = img.offsetHeight;
}

function clearCanvas() {
  const canvas = document.getElementById('modalCanvas');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  document.querySelectorAll('.detail-item').forEach(el => el.classList.remove('active'));
}

function highlightDetail(idx) {
  if (!currentDetail || !currentDetail.details) return;
  const detail = currentDetail.details[idx];
  if (!detail) return;

  document.querySelectorAll('.detail-item').forEach(el => el.classList.remove('active'));
  const item = document.getElementById(`detail-item-${idx}`);
  if (item) { item.classList.add('active'); item.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }

  const canvas = document.getElementById('modalCanvas');
  const ctx = canvas.getContext('2d');
  const img = document.getElementById('modalImg');
  canvas.width = img.offsetWidth;
  canvas.height = img.offsetHeight;
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Map location string to a region
  const regions = {
    'full-sheet': [0, 0, 1, 1],
    'top-left':    [0, 0, 0.5, 0.5],
    'top-right':   [0.5, 0, 1, 0.5],
    'top-center':  [0.2, 0, 0.8, 0.5],
    'bottom-left': [0, 0.5, 0.5, 1],
    'bottom-right':[0.5, 0.5, 1, 1],
    'bottom-center':[0.2, 0.5, 0.8, 1],
    'center':      [0.2, 0.2, 0.8, 0.8],
    'left':        [0, 0.1, 0.5, 0.9],
    'right':       [0.5, 0.1, 1, 0.9],
  };

  const loc = detail.location || 'full-sheet';
  const region = regions[loc] || regions['full-sheet'];
  const W = canvas.width, H = canvas.height;
  const x = region[0] * W, y = region[1] * H;
  const w = (region[2] - region[0]) * W, h = (region[3] - region[1]) * H;

  // Draw semi-transparent dim over everything except the region
  ctx.fillStyle = 'rgba(0,0,0,0.45)';
  ctx.fillRect(0, 0, W, H);
  ctx.clearRect(x + 4, y + 4, w - 8, h - 8);

  // Draw highlight border
  ctx.strokeStyle = '#2188d8';
  ctx.lineWidth = 3;
  ctx.shadowColor = '#2188d8';
  ctx.shadowBlur = 12;
  ctx.strokeRect(x + 4, y + 4, w - 8, h - 8);

  // Label
  ctx.shadowBlur = 0;
  ctx.fillStyle = 'rgba(33,136,216,0.9)';
  ctx.fillRect(x + 4, y + 4, Math.min(w - 8, 200), 24);
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 12px "Barlow", sans-serif';
  ctx.fillText(detail.title, x + 10, y + 20);

  // Store region for zoom and show the zoom button
  currentHighlightRegion = { x: x + 4, y: y + 4, w: w - 8, h: h - 8 };
  const zoomBtn = document.getElementById('zoomBtn');
  zoomBtn.style.display = 'flex';
  const imgSide = document.getElementById('modalImgSide');
  if (zoomActive) {
    applyZoom(); // update zoom target if already zoomed
  } else {
    imgSide.classList.add('has-detail');
    imgSide.classList.remove('zoomed');
  }
}

// ============================================================
// ZOOM
// ============================================================
function handleImgSideClick(e) {
  if (currentHighlightRegion) toggleZoom();
}

function handleZoomBtnClick(e) {
  e.stopPropagation(); // prevent double-firing with imgSide click
  toggleZoom();
}

function toggleZoom() {
  zoomActive = !zoomActive;
  const imgSide = document.getElementById('modalImgSide');
  const icon = document.getElementById('zoomBtnIcon');
  const label = document.getElementById('zoomBtnLabel');

  if (zoomActive) {
    applyZoom();
    // Switch to zoom-out icon (minus inside circle)
    icon.innerHTML = '<circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/><path d="M8 11h6"/>';
    label.textContent = 'Zoom out';
    imgSide.classList.add('zoomed');
    imgSide.classList.remove('has-detail');
  } else {
    resetZoom();
    // Switch back to zoom-in icon (plus inside circle)
    icon.innerHTML = '<circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/><path d="M11 8v6M8 11h6"/>';
    label.textContent = 'Zoom to detail';
    imgSide.classList.remove('zoomed');
    imgSide.classList.add('has-detail');
  }
}

function applyZoom() {
  if (!currentHighlightRegion) return;
  const { x, y, w, h } = currentHighlightRegion;
  const wrapper = document.getElementById('imgZoomWrapper');
  const container = document.getElementById('modalImgSide');
  const W = container.offsetWidth;
  const H = container.offsetHeight;

  // Scale so the region fills most of the container
  const scale = Math.min(W / w, H / h) * 0.88;

  // Set transform-origin to center of the region (as % of wrapper)
  const cx = ((x + w / 2) / W) * 100;
  const cy = ((y + h / 2) / H) * 100;

  wrapper.style.transformOrigin = `${cx}% ${cy}%`;
  wrapper.style.transform = `scale(${scale})`;
}

function resetZoom() {
  const wrapper = document.getElementById('imgZoomWrapper');
  wrapper.style.transform = 'scale(1)';
  wrapper.style.transformOrigin = 'center center';
}

function resetZoomState() {
  zoomActive = false;
  currentHighlightRegion = null;
  resetZoom();
  const btn = document.getElementById('zoomBtn');
  btn.style.display = 'none';
  const imgSide = document.getElementById('modalImgSide');
  imgSide.classList.remove('has-detail', 'zoomed');
  const icon = document.getElementById('zoomBtnIcon');
  const label = document.getElementById('zoomBtnLabel');
  icon.innerHTML = '<circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/><path d="M11 8v6M8 11h6"/>';
  label.textContent = 'Zoom to detail';
}

// ============================================================
// VIEWS
// ============================================================
function showView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById(`view-${name}`).classList.add('active');
}

// ============================================================
// TOASTS
// ============================================================
function toast(msg, type = 'info') {
  const container = document.getElementById('toastContainer');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  container.appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

// Close modals on overlay click
document.getElementById('detailModal').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeModal();
});
document.getElementById('newProjectModal').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeNewProjectModal();
});

// Enter key for new project
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') { closeModal(); closeNewProjectModal(); }
});
</script>
</body>
</html>
